---
title: "Clean data"
output: 
  html_document: 
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(leaflet)

```

### Import and clean raw data

```{r}
crash_df = read_csv("./data/Motor_Vehicle_Collisions_-_Crashes_20251031.csv", na = c("Unspecified", "Does Not Apply", "Unknown", "NA", ".", "")) |> 
  janitor::clean_names() |> 
  # Keep only Manhattan records
  filter(borough == "MANHATTAN") |>
  
  # Separate the crash_date column (creates character columns)
  separate(
    crash_date,
    into = c("month", "day", "year"),
    sep = "/"
  ) |> 
  mutate(year = as.numeric(year),
         month = as.numeric(month),
         day = as.numeric(day),
         hour = hour(crash_time),
         num_injured = number_of_pedestrians_injured + number_of_cyclist_injured + number_of_motorist_injured,
         num_killed = number_of_pedestrians_killed + number_of_cyclist_killed + number_of_motorist_killed,
         num_casualty = num_injured + num_killed,
         crash_date_full = make_date(year, month, day), 
         day_of_week = wday(crash_date_full, label = TRUE, abbr = FALSE)
         ) |>
  # keep data from Jan 1, 2021 up to October 31, 2025. 
  filter(
    year %in% 2021:2025 &
    !(year == 2025 & month == 11),
  ) |> 
  relocate(collision_id, year, month, day, hour, day_of_week) |> 
  # keep predictors of interests
  select(collision_id, year, month, day, hour, day_of_week, crash_time, zip_code, latitude, longitude,  num_injured, num_killed, num_casualty) |> 
  arrange(year, month, day, hour)
```


```{r}
person_df = read_csv("./data/Motor_Vehicle_Collisions_-_Person_20251031.csv", na = c("Unspecified", "Does Not Apply", "Unknown", "NA", ".", "")) |> 
  janitor::clean_names() |> 
  # keep predictors of interests
  select(collision_id, unique_id, vehicle_id, person_type, person_age, ejection, safety_equipment, ped_role, person_sex) |> 
  # keep 3 kinds of main categories of person_role, which account for 99% cases ("registrant" duplicates "driver" most the time)
  filter(ped_role %in% c("Driver", "Passenger", "Pedestrian")) |> 
  # use reasonable names
  rename(person_role = ped_role,
         person_eje = ejection,
         person_safe_equip = safety_equipment,
         person_id = unique_id)
```


```{r}
vehicle_df = read_csv("./data/Motor_Vehicle_Collisions_-_Vehicles_20251031.csv", na = c("Unspecified", "Does Not Apply", "Unknown", "NA", ".", "")) |> 
  janitor::clean_names() |> 
  # keep predictors of interests
  select(collision_id, unique_id, vehicle_type, vehicle_year, driver_license_status, driver_license_jurisdiction) |> 
  # the unqiue_id in vehicle_df is actually the vehicle_id in person_df, rename it for data joining
  rename(vehicle_id = unique_id)
```


### Join the three datasets

```{r}

# links every person to their crash details using 'collision_id'.
collision_df = crash_df |>
  left_join(person_df, by = "collision_id") |> 
# links drivers/passengers to their vehicle details using both 'collision_id' and 'vehicle_id'
  left_join(vehicle_df, by = c("collision_id", "vehicle_id")) |> 
  relocate(collision_id, vehicle_id, person_id, year, month, day, hour, day_of_week, crash_time, zip_code, latitude, longitude,  num_injured, num_killed, num_casualty, vehicle_type, vehicle_year, driver_license_status, driver_license_jurisdiction, person_type, person_role, person_age, person_sex, person_eje, person_safe_equip)

write_csv(collision_df, "./data/collision_df.csv")
```
